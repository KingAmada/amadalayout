<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Urban Layout AI (Vanilla HTML)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Lucide (UMD) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    html, body { height: 100%; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    canvas { touch-action: none; }
    /* nicer scroll */
    *::-webkit-scrollbar{ width:10px; height:10px; }
    *::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px; border:2px solid #f8fafc; }
    *::-webkit-scrollbar-track{ background:#f8fafc; }
  </style>
</head>

<body class="h-full overflow-hidden bg-gray-100">
  <div class="flex h-screen w-full bg-gray-100 overflow-hidden">
    <!-- SIDEBAR -->
    <div class="w-96 bg-white shadow-xl z-10 flex flex-col h-full border-r border-gray-200">
      <div class="p-4 border-b border-gray-200 bg-slate-50">
        <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
          <i data-lucide="layout" class="w-6 h-6 text-blue-600"></i>
          Urban Layout AI
        </h1>

        <div class="flex gap-2 mt-4">
          <button id="btnTabConfig"
            class="flex-1 py-1.5 text-xs font-semibold rounded flex items-center justify-center gap-2 bg-blue-600 text-white shadow">
            <i data-lucide="settings" class="w-4 h-4"></i> Edit Dimensions
          </button>
          <button id="btnTabStats"
            class="flex-1 py-1.5 text-xs font-semibold rounded flex items-center justify-center gap-2 bg-gray-200 text-gray-600 hover:bg-gray-300">
            <i data-lucide="info" class="w-4 h-4"></i> Analytics
          </button>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 space-y-6">
        <!-- CONFIG TAB -->
        <div id="tabConfig" class="space-y-6">
          <div class="space-y-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
              <i data-lucide="map" class="w-3 h-3"></i> Infrastructure (Meters)
            </h3>

            <div class="grid grid-cols-2 gap-3">
              <div class="flex flex-col">
                <label class="text-xs text-slate-500 mb-1">Main Blvd Width</label>
                <input id="mainRoadWidth" type="number"
                  class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" />
              </div>
              <div class="flex flex-col">
                <label class="text-xs text-slate-500 mb-1">Res. Street Width</label>
                <input id="resStreetWidth" type="number"
                  class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" />
              </div>
              <div class="flex flex-col col-span-2">
                <label class="text-xs text-slate-500 mb-1">Res. Roundabout R</label>
                <input id="resRoundaboutRadius" type="number"
                  class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" />
              </div>
            </div>
          </div>

          <div class="h-px bg-gray-200"></div>

          <div class="space-y-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
              <i data-lucide="home" class="w-3 h-3"></i> Housing Units (Meters)
            </h3>

            <div class="mb-4">
              <span class="text-xs font-semibold text-blue-600 block mb-2">Standard Row House</span>
              <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col">
                  <label class="text-xs text-slate-500 mb-1">Frontage (Width)</label>
                  <input id="houseWidth" type="number"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" />
                </div>
                <div class="flex flex-col">
                  <label class="text-xs text-slate-500 mb-1">Depth (Length)</label>
                  <input id="houseDepth" type="number"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" />
                </div>
              </div>
            </div>

            <div class="p-3 bg-purple-50 rounded border border-purple-100">
              <span class="text-xs font-semibold text-purple-700 block mb-2 flex items-center gap-1">
                <i data-lucide="crown" class="w-3 h-3"></i> Street-End Maisonette
              </span>
              <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col">
                  <label class="text-xs text-slate-500 mb-1">Width</label>
                  <input id="mansionWidth" type="number"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" />
                </div>
                <div class="flex flex-col">
                  <label class="text-xs text-slate-500 mb-1">Depth</label>
                  <input id="mansionDepth" type="number"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" />
                </div>
              </div>
            </div>
          </div>

          <div class="h-px bg-gray-200"></div>

          <div class="space-y-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
              <i data-lucide="building-2" class="w-3 h-3"></i> Amenities (Width x Length)
            </h3>

            <div id="amenitiesRows" class="space-y-2"></div>
          </div>
        </div>

        <!-- STATS TAB -->
        <div id="tabStats" class="space-y-6 hidden">
          <div class="space-y-3">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Land Usage</h2>
            <div id="statsBars" class="space-y-3"></div>
          </div>

          <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 mt-4">
            <h2 class="text-sm font-semibold text-slate-800 mb-2 flex items-center gap-2">
              <i data-lucide="info" class="w-4 h-4"></i> Inspector
            </h2>

            <div id="inspectorEmpty" class="text-slate-400 text-sm italic">
              Hover over the map to inspect lots, roads, and buildings.
            </div>

            <div id="inspectorFilled" class="space-y-2 text-sm hidden">
              <div class="flex justify-between">
                <span class="text-slate-500">Name:</span>
                <span id="insName" class="font-medium text-blue-700"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-500">Type:</span>
                <span id="insType" class="capitalize"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-500">Dimensions:</span>
                <span id="insDim" class="font-mono text-xs text-slate-700"></span>
              </div>
              <div class="flex justify-between items-center bg-blue-50 p-2 rounded border border-blue-100 mt-2">
                <span class="text-blue-800 font-semibold">Total Area:</span>
                <span id="insArea" class="font-mono font-bold text-blue-900"></span>
              </div>
              <p class="text-xs text-slate-500 mt-2 italic flex items-center gap-1">
                <i data-lucide="layout" class="w-3 h-3"></i> Click to view layout
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- MAIN VIEWPORT -->
    <div class="flex-1 relative bg-slate-200 overflow-hidden cursor-move">
      <canvas id="mapCanvas" width="2400" height="3000" class="w-full h-full"></canvas>

      <!-- OVERLAY CONTROLS -->
      <div class="absolute top-4 right-4 flex flex-col gap-2">
        <button id="btnZoomIn" class="p-2 bg-white rounded shadow hover:bg-gray-50" title="Zoom In">
          <i data-lucide="zoom-in" class="w-5 h-5"></i>
        </button>
        <button id="btnZoomOut" class="p-2 bg-white rounded shadow hover:bg-gray-50" title="Zoom Out">
          <i data-lucide="zoom-out" class="w-5 h-5"></i>
        </button>
        <button id="btnReset" class="p-2 bg-white rounded shadow hover:bg-gray-50" title="Reset View">
          <i data-lucide="maximize" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded shadow text-xs text-slate-600 pointer-events-none">
        Drag car to check scale. Scroll to zoom. Click houses for layout.
      </div>

      <!-- MODAL ROOT -->
      <div id="modalRoot" class="absolute inset-0 hidden"></div>
    </div>
  </div>

<script>
(() => {
  // --- CONSTANTS & CONFIGURATION ---
  // 1 Unit = 1 Meter
  const LAND_WIDTH_M = 280;
  const LAND_HEIGHT_M = 420;

  // Boundary Coordinates
  const BOUNDARY = {
    tl: { x: 10, y: 10 },
    tr: { x: 257, y: 10 },
    br: { x: 230, y: 409 },
    bl: { x: 10, y: 377 }
  };

  const TOTAL_AREA_SQM = 93000; // ~9.3 Hectares

  // Colors
  const COLORS = {
    grass: '#f0fdf4',
    boundary: '#15803d',
    road: '#374151',
    roadMarking: '#f3f4f6',
    residential: '#bfdbfe',
    residentialHighlight: '#60a5fa',
    mansion: '#c4b5fd',
    mansionHighlight: '#a78bfa',
    commercial: '#fca5a5',
    commercialHighlight: '#f87171',
    resort: '#fde68a',
    school: '#ddd6fe',
    park: '#86efac',
    water: '#7dd3fc',
    car: '#ef4444'
  };

  // --- HELPER CLASSES ---
  class Rectangle {
    constructor(x, y, w, h, type, label, details = {}) {
      this.x = x; this.y = y; this.w = w; this.h = h;
      this.type = type; this.label = label; this.details = details;
    }
    contains(mx, my) {
      return mx >= this.x && mx <= this.x + this.w && my >= this.y && my <= this.y + this.h;
    }
  }

  // --- STATE ---
  const canvas = document.getElementById('mapCanvas');
  const ctx = canvas.getContext('2d');

  let scale = 1.8;
  let offset = { x: 40, y: 40 };
  let hoveredItem = null;
  let showGrid = true;

  let carPosition = { x: 140, y: 380, rotation: 0 };
  let isDraggingCar = false;
  let isPanning = false;
  let lastMousePos = { x: 0, y: 0 };
  let clickStartPos = { x: 0, y: 0 };

  let activeTab = 'config';
  let selectedLot = null;

  let config = {
    mainRoadWidth: 16,
    resStreetWidth: 12,
    resRoundaboutRadius: 8,

    houseWidth: 15,
    houseDepth: 18,

    mansionWidth: 22,
    mansionDepth: 25,

    waterWidth: 90,
    waterDepth: 80,

    resortWidth: 90,
    resortDepth: 50,

    parkWidth: 90,
    parkDepth: 90,

    schoolWidth: 90,
    schoolDepth: 40,

    mallWidth: 90,
    mallDepth: 60,

    mallParkingWidth: 90,
    mallParkingDepth: 20
  };

  let layoutData = [];
  let stats = { residential: 0, road: 0, commercial: 0, green: 0, public: 0 };

  // --- BOUNDARY MATH ---
  function getRightBoundaryX(y) {
    const x1 = BOUNDARY.tr.x, y1 = BOUNDARY.tr.y;
    const x2 = BOUNDARY.br.x, y2 = BOUNDARY.br.y;
    return x1 + (y - y1) * (x2 - x1) / (y2 - y1);
  }

  function getBottomBoundaryY(x) {
    const x1 = BOUNDARY.bl.x, y1 = BOUNDARY.bl.y;
    const x2 = BOUNDARY.br.x, y2 = BOUNDARY.br.y;
    if (x2 === x1) return y1;
    return y1 + (x - x1) * (y2 - y1) / (x2 - x1);
  }

  // --- LAYOUT GENERATION ---
  function computeLayoutData() {
    const elements = [];

    const mainRoadWidth = Number(config.mainRoadWidth);
    const houseWidth = Number(config.houseWidth);
    const houseDepth = Number(config.houseDepth);
    const resStreetWidth = Number(config.resStreetWidth);
    const mansionWidth = Number(config.mansionWidth);
    const mansionDepth = Number(config.mansionDepth);

    // 1) Dynamic main road positioning
    const leftMargin = 5;
    const requiredHousingWidth = mansionWidth + 5 + (7 * houseWidth);
    const maxMainRoadX = 220;
    const calculatedMainRoadX = leftMargin + requiredHousingWidth + 5;
    const mainRoadX = Math.min(maxMainRoadX, Math.max(140, calculatedMainRoadX));

    const mainRoadHeight = getBottomBoundaryY(mainRoadX + mainRoadWidth / 2) - 10;
    elements.push(new Rectangle(mainRoadX, 10, mainRoadWidth, mainRoadHeight, 'road', 'Main Boulevard', { width: mainRoadWidth }));

    // 2) Left side: Residential (5 streets)
    const resZoneCenterX = (leftMargin + mainRoadX) / 2;
    const resZoneBottomY = getBottomBoundaryY(resZoneCenterX);
    const resZoneTopY = 20;
    const availableResHeight = resZoneBottomY - resZoneTopY;

    const rowHouseBlockHeight = (houseDepth * 2) + resStreetWidth;
    const singleBlockHeight = Math.max(rowHouseBlockHeight, mansionDepth);
    const totalRequiredHeight = 5 * singleBlockHeight;

    let blockGap = 10;
    if (totalRequiredHeight > availableResHeight) blockGap = 0;
    else blockGap = (availableResHeight - totalRequiredHeight) / 6;

    const raboutRadius = Number(config.resRoundaboutRadius);

    for (let i = 0; i < 5; i++) {
      const blockStartY = resZoneTopY + blockGap + (i * (singleBlockHeight + blockGap));
      const streetY = blockStartY + houseDepth;
      if (blockStartY + singleBlockHeight > resZoneBottomY) break;

      // Roundabout
      elements.push(
        new Rectangle(
          mainRoadX - raboutRadius + mainRoadWidth / 2,
          streetY + resStreetWidth / 2 - raboutRadius,
          raboutRadius * 2,
          raboutRadius * 2,
          'roundabout',
          `Circle ${i + 1}`,
          { radius: raboutRadius }
        )
      );

      // Mansion
      const streetCenterY = streetY + resStreetWidth / 2;
      const mansionY = streetCenterY - (mansionDepth / 2);
      elements.push(new Rectangle(leftMargin, mansionY, mansionWidth, mansionDepth, 'mansion', `Mansion ${i + 1}`, {
        zoning: 'residential',
        area: mansionWidth * mansionDepth,
        dim: `${mansionWidth}x${mansionDepth}m`
      }));

      // Street
      const streetStartX = leftMargin + mansionWidth;
      const streetEndX = mainRoadX - raboutRadius + mainRoadWidth / 2;
      elements.push(new Rectangle(streetStartX, streetY, streetEndX - streetStartX, resStreetWidth, 'road', `Residential St ${i + 1}`, { width: resStreetWidth }));

      // Houses
      const rowHouseStartX = streetStartX + 2;

      for (let h = 0; h < 7; h++) {
        const hx = rowHouseStartX + (h * houseWidth);
        if (hx + houseWidth > streetEndX - 2) break;
        elements.push(new Rectangle(hx + 1, blockStartY, houseWidth - 2, houseDepth, 'lot', `Unit ${i + 1}A-${h + 1}`, {
          zoning: 'residential',
          area: (houseWidth - 2) * houseDepth,
          dim: `${houseWidth - 2}x${houseDepth}m`
        }));
      }
      for (let h = 0; h < 7; h++) {
        const hx = rowHouseStartX + (h * houseWidth);
        if (hx + houseWidth > streetEndX - 2) break;
        elements.push(new Rectangle(hx + 1, streetY + resStreetWidth, houseWidth - 2, houseDepth, 'lot', `Unit ${i + 1}B-${h + 1}`, {
          zoning: 'residential',
          area: (houseWidth - 2) * houseDepth,
          dim: `${houseWidth - 2}x${houseDepth}m`
        }));
      }
    }

    // 3) Right side: Amenities
    const rightZoneX = mainRoadX + mainRoadWidth;
    const amTopY = 20;
    const amBottomY = getBottomBoundaryY(rightZoneX + 40) - 10;
    const availableAmHeight = amBottomY - amTopY;

    const dims = [
      { h: Number(config.waterDepth), w: Number(config.waterWidth), type: 'water', label: 'Lagoon', zoning: 'water' },
      { h: Number(config.resortDepth), w: Number(config.resortWidth), type: 'building', label: 'Resort', zoning: 'resort' },
      { h: Number(config.parkDepth), w: Number(config.parkWidth), type: 'park', label: 'Park/Golf', zoning: 'park' },
      { h: Number(config.schoolDepth), w: Number(config.schoolWidth), type: 'building', label: 'School', zoning: 'school' },
      { h: Number(config.mallDepth), w: Number(config.mallWidth), type: 'building', label: 'Mall', zoning: 'commercial' },
      { h: Number(config.mallParkingDepth), w: Number(config.mallParkingWidth), type: 'road', label: 'Parking', zoning: 'parking' }
    ];

    const totalAmHeight = dims.reduce((acc, d) => acc + d.h, 0);
    let amGap = 10;
    if (totalAmHeight > availableAmHeight) amGap = 0;
    else amGap = (availableAmHeight - totalAmHeight) / 5;

    let currentY = amTopY;

    dims.forEach(d => {
      const currentMaxX = getRightBoundaryX(currentY + d.h / 2);
      const availableW = (currentMaxX - rightZoneX) - 5;
      const finalW = Math.min(d.w, availableW);

      const rect = new Rectangle(rightZoneX + 2, currentY, finalW, d.h, d.type, d.label, { zoning: d.zoning, area: finalW * d.h });

      // make park dots stable (no flicker)
      if (d.type === 'park') {
        const dots = [];
        // deterministic-ish: based on position
        const seed = Math.floor((rect.x + rect.y + rect.w + rect.h) * 10);
        let s = seed;
        function rnd() { s = (s * 1664525 + 1013904223) >>> 0; return (s / 4294967296); }
        for (let i = 0; i < 15; i++) {
          dots.push({ x: rect.x + rnd() * rect.w, y: rect.y + rnd() * rect.h });
        }
        rect.details.treeDots = dots;
      }

      elements.push(rect);
      currentY += d.h + amGap;
    });

    return elements;
  }

  function computeStats() {
    const s = { residential: 0, road: 0, commercial: 0, green: 0, public: 0 };
    layoutData.forEach(el => {
      const area = el.w * el.h;
      if (el.type === 'lot' || el.type === 'mansion') s.residential += area;
      else if (el.type === 'road' || el.type === 'roundabout') s.road += area;
      else if (el.details.zoning === 'commercial' || el.details.zoning === 'resort') s.commercial += area;
      else if (el.details.zoning === 'school') s.public += area;
      else if (el.type === 'park' || el.type === 'water') s.green += area;
    });
    return s;
  }

  // --- CANVAS RENDERING ---
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(offset.x, offset.y);
    ctx.scale(scale, scale);

    // boundary
    ctx.beginPath();
    ctx.moveTo(BOUNDARY.tl.x, BOUNDARY.tl.y);
    ctx.lineTo(BOUNDARY.tr.x, BOUNDARY.tr.y);
    ctx.lineTo(BOUNDARY.br.x, BOUNDARY.br.y);
    ctx.lineTo(BOUNDARY.bl.x, BOUNDARY.bl.y);
    ctx.closePath();

    ctx.fillStyle = COLORS.grass;
    ctx.fill();
    ctx.strokeStyle = COLORS.boundary;
    ctx.lineWidth = 1.5;
    ctx.stroke();

    // labels
    ctx.fillStyle = '#166534';
    ctx.font = '4px Arial';
    ctx.fillText('Back: 247m', 120, 8);
    ctx.fillText('Front: 207m', 100, 415);

    ctx.save();
    ctx.translate(5, 200);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Side: 367m', 0, 0);
    ctx.restore();

    ctx.save();
    ctx.translate(265, 200);
    ctx.rotate(Math.PI / 2);
    ctx.fillText('Side: 399m', 0, 0);
    ctx.restore();

    // grid
    if (showGrid) {
      ctx.beginPath();
      ctx.strokeStyle = '#d1d5db';
      ctx.lineWidth = 0.1;
      for (let i = 0; i <= LAND_WIDTH_M; i += 10) { ctx.moveTo(i, 0); ctx.lineTo(i, LAND_HEIGHT_M); }
      for (let i = 0; i <= LAND_HEIGHT_M; i += 10) { ctx.moveTo(0, i); ctx.lineTo(LAND_WIDTH_M, i); }
      ctx.stroke();
    }

    // elements
    for (const el of layoutData) {
      if (el.type === 'road') {
        ctx.fillStyle = COLORS.road;
        ctx.fillRect(el.x, el.y, el.w, el.h);

        ctx.beginPath();
        ctx.strokeStyle = COLORS.roadMarking;
        ctx.setLineDash([2, 4]);
        ctx.lineWidth = 0.3;

        if (el.w > el.h) {
          ctx.moveTo(el.x, el.y + el.h / 2);
          ctx.lineTo(el.x + el.w, el.y + el.h / 2);
        } else {
          ctx.moveTo(el.x + el.w / 2, el.y);
          ctx.lineTo(el.x + el.w / 2, el.y + el.h);
        }
        ctx.stroke();
        ctx.setLineDash([]);
      } else if (el.type === 'roundabout') {
        ctx.fillStyle = COLORS.road;
        ctx.beginPath();
        const r = el.w / 2;
        ctx.arc(el.x + r, el.y + r, r, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = COLORS.grass;
        ctx.beginPath();
        ctx.arc(el.x + r, el.y + r, r * 0.4, 0, Math.PI * 2);
        ctx.fill();
      } else if (el.type === 'lot') {
        const isHovered = hoveredItem === el;
        ctx.fillStyle = isHovered ? COLORS.residentialHighlight : COLORS.residential;
        ctx.fillRect(el.x, el.y, el.w, el.h);

        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        const margin = 2;
        if (el.w > margin * 2 && el.h > margin * 2) {
          ctx.fillRect(el.x + margin, el.y + margin, el.w - margin * 2, el.h - margin * 2);
        }
      } else if (el.type === 'mansion') {
        const isHovered = hoveredItem === el;
        ctx.fillStyle = isHovered ? COLORS.mansionHighlight : COLORS.mansion;
        ctx.fillRect(el.x, el.y, el.w, el.h);

        ctx.beginPath();
        ctx.strokeStyle = 'rgba(0,0,0,0.1)';
        ctx.lineWidth = 0.5;
        ctx.moveTo(el.x, el.y);
        ctx.lineTo(el.x + el.w, el.y + el.h);
        ctx.moveTo(el.x + el.w, el.y);
        ctx.lineTo(el.x, el.y + el.h);
        ctx.stroke();
      } else if (el.type === 'building') {
        const isHovered = hoveredItem === el;
        if (el.details.zoning === 'commercial') ctx.fillStyle = isHovered ? COLORS.commercialHighlight : COLORS.commercial;
        if (el.details.zoning === 'school') ctx.fillStyle = COLORS.school;
        if (el.details.zoning === 'resort') ctx.fillStyle = COLORS.resort;

        ctx.fillRect(el.x, el.y, el.w, el.h);
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.font = '3px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(el.label, el.x + el.w / 2, el.y + el.h / 2);
        ctx.textAlign = 'start';
      } else if (el.type === 'park') {
        ctx.fillStyle = COLORS.park;
        ctx.fillRect(el.x, el.y, el.w, el.h);

        ctx.fillStyle = '#15803d';
        const dots = el.details.treeDots || [];
        for (const p of dots) {
          ctx.beginPath();
          ctx.arc(p.x, p.y, 1.5, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (el.type === 'water') {
        ctx.fillStyle = COLORS.water;
        ctx.fillRect(el.x, el.y, el.w, el.h);

        ctx.strokeStyle = 'rgba(255,255,255,0.5)';
        ctx.lineWidth = 0.5;
        for (let i = 0; i < 5; i++) {
          ctx.beginPath();
          const waveY = el.y + 10 + (i * 10);
          ctx.moveTo(el.x, waveY);
          ctx.bezierCurveTo(el.x + el.w / 3, waveY - 5, el.x + 2 * el.w / 3, waveY + 5, el.x + el.w, waveY);
          ctx.stroke();
        }
      }
    }

    // hovered outline
    if (hoveredItem && hoveredItem.type !== 'roundabout') {
      ctx.strokeStyle = '#ef4444';
      ctx.lineWidth = 1;
      ctx.strokeRect(hoveredItem.x, hoveredItem.y, hoveredItem.w, hoveredItem.h);
    }

    // car
    ctx.save();
    ctx.translate(carPosition.x, carPosition.y);
    ctx.rotate((carPosition.rotation * Math.PI) / 180);
    ctx.fillStyle = COLORS.car;
    const carLen = 4.5;
    const carWid = 1.8;
    ctx.fillRect(-carLen / 2, -carWid / 2, carLen, carWid);
    ctx.fillStyle = '#9ca3af';
    ctx.fillRect(-carLen / 4, -carWid / 2 + 0.2, carLen / 2, carWid - 0.4);
    ctx.restore();

    ctx.restore();
  }

  // --- UI RENDERING ---
  const amenitiesRows = document.getElementById('amenitiesRows');
  const statsBars = document.getElementById('statsBars');
  const modalRoot = document.getElementById('modalRoot');

  function renderAmenitiesInputs() {
    const rows = [
      { label: 'Lagoon/Beach', k1: 'waterWidth', k2: 'waterDepth' },
      { label: 'Resort Hotel', k1: 'resortWidth', k2: 'resortDepth' },
      { label: 'Park & Golf', k1: 'parkWidth', k2: 'parkDepth' },
      { label: 'School', k1: 'schoolWidth', k2: 'schoolDepth' },
      { label: 'Mall', k1: 'mallWidth', k2: 'mallDepth' },
      { label: 'Mall Parking', k1: 'mallParkingWidth', k2: 'mallParkingDepth' }
    ];

    amenitiesRows.innerHTML = rows.map(r => `
      <div class="flex flex-col mb-1">
        <label class="text-xs text-slate-500 mb-1">${r.label}</label>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <span class="absolute left-1.5 top-1 text-[10px] text-gray-400">W</span>
            <input type="number" data-key="${r.k1}" value="${config[r.k1]}"
              class="w-full border border-gray-300 rounded pl-4 pr-1 py-1 text-xs focus:border-blue-500 outline-none" />
          </div>
          <div class="relative flex-1">
            <span class="absolute left-1.5 top-1 text-[10px] text-gray-400">L</span>
            <input type="number" data-key="${r.k2}" value="${config[r.k2]}"
              class="w-full border border-gray-300 rounded pl-4 pr-1 py-1 text-xs focus:border-blue-500 outline-none" />
          </div>
        </div>
      </div>
    `).join('');

    amenitiesRows.querySelectorAll('input[data-key]').forEach(inp => {
      inp.addEventListener('input', (e) => {
        const k = e.target.getAttribute('data-key');
        config[k] = Number(e.target.value);
        recomputeAndRedraw();
      });
    });
  }

  function statBarHTML({ label, icon, colorClass, value, total }) {
    const percent = Math.round((value / total) * 100);
    const sqm = Math.round(value).toLocaleString();
    return `
      <div>
        <div class="flex justify-between items-end mb-1">
          <span class="text-xs font-medium text-slate-700 flex items-center gap-1.5">
            <i data-lucide="${icon}" class="w-4 h-4"></i> ${label}
          </span>
          <span class="text-xs font-bold text-slate-900">
            ${percent}% <span class="text-slate-400 font-normal">(${sqm} m²)</span>
          </span>
        </div>
        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
          <div class="h-full ${colorClass}" style="width:${percent}%"></div>
        </div>
      </div>
    `;
  }

  function renderStatsBars() {
    statsBars.innerHTML = [
      statBarHTML({ label: 'Residential (Left)', icon: 'home', colorClass: 'bg-blue-400', value: stats.residential, total: TOTAL_AREA_SQM }),
      statBarHTML({ label: 'Roads & Access', icon: 'map', colorClass: 'bg-slate-600', value: stats.road, total: TOTAL_AREA_SQM }),
      statBarHTML({ label: 'Commercial & Resort', icon: 'building-2', colorClass: 'bg-red-400', value: stats.commercial, total: TOTAL_AREA_SQM }),
      statBarHTML({ label: 'Green & Water', icon: 'trees', colorClass: 'bg-green-400', value: stats.green, total: TOTAL_AREA_SQM }),
      statBarHTML({ label: 'Public/School', icon: 'info', colorClass: 'bg-purple-400', value: stats.public, total: TOTAL_AREA_SQM })
    ].join('');

    lucide.createIcons();
  }

  function setInspector(item) {
    const empty = document.getElementById('inspectorEmpty');
    const filled = document.getElementById('inspectorFilled');

    if (!item) {
      filled.classList.add('hidden');
      empty.classList.remove('hidden');
      return;
    }

    empty.classList.add('hidden');
    filled.classList.remove('hidden');

    document.getElementById('insName').textContent = item.label;
    document.getElementById('insType').textContent = item.type;
    document.getElementById('insDim').textContent = `${item.w.toFixed(1)}m x ${item.h.toFixed(1)}m`;
    document.getElementById('insArea').textContent = `${(item.w * item.h).toFixed(0)} sqm`;

    lucide.createIcons();
  }

  // --- MODAL (FLOOR PLAN) ---
  function buildRooms(lot) {
    const isMansion = lot.type === 'mansion';
    const w = lot.w, h = lot.h;
    const r = [];

    if (isMansion) {
      const foyerW = w * 0.4, foyerH = h * 0.25;
      r.push({ x: (w - foyerW) / 2, y: h - foyerH, w: foyerW, h: foyerH, name: 'Grand Foyer', color: '#f3e8ff' });

      const greatW = w * 0.5, greatH = h * 0.4;
      r.push({ x: (w - greatW) / 2, y: h - foyerH - greatH, w: greatW, h: greatH, name: 'Great Room', color: '#e9d5ff' });

      r.push({ x: w - (w * 0.3), y: h * 0.3, w: w * 0.3, h: h * 0.7, name: 'Kitchen & Dining', color: '#fce7f3' });
      r.push({ x: 0, y: h * 0.4, w: w * 0.25, h: h * 0.6, name: 'Master Suite', color: '#dbeafe' });
      r.push({ x: 0, y: 0, w: w * 0.4, h: h * 0.4, name: 'Study/Guest', color: '#e0f2fe' });
      r.push({ x: w * 0.4, y: 0, w: w * 0.6, h: h * 0.3, name: 'Terrace', color: '#ecfccb', isOutdoor: true });
    } else {
      const garageW = 3.5, garageH = 6;
      if (w > 6) r.push({ x: 0, y: h - garageH, w: garageW, h: garageH, name: 'Garage', color: '#e5e7eb' });

      const livingW = w - (w > 6 ? garageW : 0);
      r.push({ x: (w > 6 ? garageW : 0), y: h * 0.5, w: livingW, h: h * 0.5, name: 'Living & Dining', color: '#dbeafe' });

      r.push({ x: 0, y: h * 0.25, w: w, h: h * 0.25, name: 'Kitchen', color: '#fae8ff' });

      r.push({ x: 0, y: 0, w: w * 0.5, h: h * 0.25, name: 'Master Bed', color: '#d1fae5' });
      r.push({ x: w * 0.5, y: 0, w: w * 0.5, h: h * 0.25, name: 'Bed 2', color: '#d1fae5' });
    }
    return r;
  }

  function openFloorPlanModal(lot) {
    selectedLot = lot;
    const isMansion = lot.type === 'mansion';
    const w = lot.w, h = lot.h;
    const maxDim = Math.max(w, h);
    const sc = 300 / maxDim;
    const rooms = buildRooms(lot);

    modalRoot.classList.remove('hidden');
    modalRoot.innerHTML = `
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4" id="modalBackdrop">
        <div class="bg-white rounded-lg shadow-2xl overflow-hidden max-w-lg w-full flex flex-col max-h-[90vh]">

          <div class="p-4 border-b flex justify-between items-center ${isMansion ? 'bg-purple-50' : 'bg-blue-50'}">
            <div>
              <h3 class="font-bold text-lg ${isMansion ? 'text-purple-900' : 'text-blue-900'}">${lot.label}</h3>
              <p class="text-xs text-gray-500">${w.toFixed(1)}m x ${h.toFixed(1)}m | ${(w*h).toFixed(0)} sqm</p>
            </div>
            <button id="btnCloseX" class="p-2 hover:bg-black/5 rounded-full text-gray-500">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="p-6 overflow-y-auto flex flex-col items-center">
            <div class="relative border-4 border-slate-800 bg-white shadow-lg mb-6" style="width:${w*sc}px;height:${h*sc}px;">
              ${rooms.map((room) => `
                <div class="absolute border border-slate-300 flex items-center justify-center text-center p-1"
                  style="left:${room.x*sc}px;top:${room.y*sc}px;width:${room.w*sc}px;height:${room.h*sc}px;background:${room.color};">
                  <span class="text-[10px] font-medium leading-tight text-slate-700">${room.name}</span>
                </div>
              `).join('')}
              <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 w-6 h-3 bg-slate-800 rounded-b text-[8px] text-white flex items-center justify-center">
                Entry
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full text-sm">
              <div class="bg-slate-50 p-3 rounded border border-slate-100">
                <h4 class="font-semibold text-slate-700 mb-2 flex items-center gap-2">
                  <i data-lucide="utensils" class="w-4 h-4"></i> Ground Floor
                </h4>
                <ul class="space-y-1 text-slate-500 text-xs">
                  <li>• Open Concept Living</li>
                  <li>• Modern Kitchen</li>
                  <li>• Dining Area</li>
                  ${isMansion ? `<li>• Grand Foyer</li>` : ``}
                </ul>
              </div>
              <div class="bg-slate-50 p-3 rounded border border-slate-100">
                <h4 class="font-semibold text-slate-700 mb-2 flex items-center gap-2">
                  <i data-lucide="bed-double" class="w-4 h-4"></i> Private Zones
                </h4>
                <ul class="space-y-1 text-slate-500 text-xs">
                  <li>• Master Suite</li>
                  <li>• ${isMansion ? '3' : '2'} Guest Bedrooms</li>
                  <li>• ${isMansion ? '4' : '2.5'} Bathrooms</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="p-4 bg-gray-50 border-t text-center">
            <button id="btnClose" class="px-6 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 text-sm font-medium">
              Close View
            </button>
          </div>
        </div>
      </div>
    `;

    const backdrop = document.getElementById('modalBackdrop');
    backdrop.addEventListener('click', (e) => {
      if (e.target === backdrop) closeFloorPlanModal();
    });
    document.getElementById('btnClose').addEventListener('click', closeFloorPlanModal);
    document.getElementById('btnCloseX').addEventListener('click', closeFloorPlanModal);

    lucide.createIcons();
  }

  function closeFloorPlanModal() {
    selectedLot = null;
    modalRoot.classList.add('hidden');
    modalRoot.innerHTML = '';
  }

  // --- INPUT BINDINGS ---
  function bindTopInputs() {
    const keys = [
      'mainRoadWidth','resStreetWidth','resRoundaboutRadius',
      'houseWidth','houseDepth','mansionWidth','mansionDepth'
    ];
    keys.forEach(k => {
      const el = document.getElementById(k);
      el.value = config[k];
      el.addEventListener('input', (e) => {
        config[k] = Number(e.target.value);
        recomputeAndRedraw();
      });
    });
  }

  // --- TABS ---
  function setTab(name) {
    activeTab = name;
    const tabConfig = document.getElementById('tabConfig');
    const tabStats = document.getElementById('tabStats');
    const btnConfig = document.getElementById('btnTabConfig');
    const btnStats = document.getElementById('btnTabStats');

    if (name === 'config') {
      tabConfig.classList.remove('hidden');
      tabStats.classList.add('hidden');
      btnConfig.className = "flex-1 py-1.5 text-xs font-semibold rounded flex items-center justify-center gap-2 bg-blue-600 text-white shadow";
      btnStats.className = "flex-1 py-1.5 text-xs font-semibold rounded flex items-center justify-center gap-2 bg-gray-200 text-gray-600 hover:bg-gray-300";
    } else {
      tabConfig.classList.add('hidden');
      tabStats.classList.remove('hidden');
      btnStats.className = "flex-1 py-1.5 text-xs font-semibold rounded flex items-center justify-center gap-2 bg-blue-600 text-white shadow";
      btnConfig.className = "flex-1 py-1.5 text-xs font-semibold rounded flex items-center justify-center gap-2 bg-gray-200 text-gray-600 hover:bg-gray-300";
      renderStatsBars();
      setInspector(hoveredItem);
    }
    lucide.createIcons();
  }

  document.getElementById('btnTabConfig').addEventListener('click', () => setTab('config'));
  document.getElementById('btnTabStats').addEventListener('click', () => setTab('stats'));

  // --- CANVAS EVENTS ---
  function getMouseWorld(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    const mouseX = (e.clientX - rect.left) * scaleX;
    const mouseY = (e.clientY - rect.top) * scaleY;

    const worldX = (mouseX - offset.x) / scale;
    const worldY = (mouseY - offset.y) / scale;

    return { rect, scaleX, scaleY, mouseX, mouseY, worldX, worldY };
  }

  canvas.addEventListener('mousedown', (e) => {
    clickStartPos = { x: e.clientX, y: e.clientY };

    const { worldX, worldY } = getMouseWorld(e);
    const distToCar = Math.hypot(worldX - carPosition.x, worldY - carPosition.y);

    if (distToCar < 8) {
      isDraggingCar = true;
      return;
    }

    isPanning = true;
    lastMousePos = { x: e.clientX, y: e.clientY };
  });

  canvas.addEventListener('mousemove', (e) => {
    const { scaleX, scaleY, worldX, worldY } = getMouseWorld(e);

    if (isDraggingCar) {
      carPosition = { ...carPosition, x: worldX, y: worldY };
      draw();
      return;
    }

    if (isPanning) {
      const dx = (e.clientX - lastMousePos.x) * scaleX;
      const dy = (e.clientY - lastMousePos.y) * scaleY;
      offset = { x: offset.x + dx, y: offset.y + dy };
      lastMousePos = { x: e.clientX, y: e.clientY };
      draw();
      return;
    }

    // hover detection
    let found = null;
    for (let i = layoutData.length - 1; i >= 0; i--) {
      if (layoutData[i].contains(worldX, worldY)) { found = layoutData[i]; break; }
    }
    hoveredItem = found;
    if (activeTab === 'stats') setInspector(hoveredItem);
    draw();
  });

  function onMouseUp(e) {
    const dx = e.clientX - clickStartPos.x;
    const dy = e.clientY - clickStartPos.y;
    const dist = Math.hypot(dx, dy);

    if (dist < 5 && !isDraggingCar) {
      if (hoveredItem && (hoveredItem.type === 'lot' || hoveredItem.type === 'mansion')) {
        openFloorPlanModal(hoveredItem);
      }
    }

    isDraggingCar = false;
    isPanning = false;
  }

  canvas.addEventListener('mouseup', onMouseUp);
  canvas.addEventListener('mouseleave', onMouseUp);

  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const newScale = Math.max(0.5, Math.min(10, scale - e.deltaY * 0.005));
    scale = newScale;
    draw();
  }, { passive: false });

  // overlay buttons
  document.getElementById('btnZoomIn').addEventListener('click', () => { scale = scale * 1.2; draw(); });
  document.getElementById('btnZoomOut').addEventListener('click', () => { scale = scale / 1.2; draw(); });
  document.getElementById('btnReset').addEventListener('click', () => { scale = 1.8; offset = { x: 40, y: 40 }; draw(); });

  // --- RECOMPUTE PIPELINE ---
  function recomputeAndRedraw() {
    layoutData = computeLayoutData();
    stats = computeStats();
    if (activeTab === 'stats') renderStatsBars();
    draw();
  }

  // --- INIT ---
  function init() {
    renderAmenitiesInputs();
    bindTopInputs();
    layoutData = computeLayoutData();
    stats = computeStats();
    draw();
    lucide.createIcons();
  }

  init();
})();
</script>
</body>
</html>
